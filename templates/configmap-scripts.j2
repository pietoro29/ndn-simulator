apiVersion: v1
kind: ConfigMap
metadata:
  name: ndn-scripts
data:
  nfd.conf: |
    {{ nfd_conf | indent(4) }}

  entrypoint.sh: |
    #!/bin/bash
    set -e

    NODE_NAME=$1
    echo "=== Initializing Node: ${NODE_NAME} ==="
    mkdir -p /usr/local/etc/ndn
    cp /scripts/nfd.conf /usr/local/etc/ndn/nfd.conf
    mkdir -p /etc/nlsr
    cp /bootstrap/nlsr/nlsr.conf /etc/nlsr/nlsr.conf

    mkdir -p /run/nfd
    export HOME=/root

    if [ "$SECURITY_MODE" == "strict" ]; then
        echo "--- [Strict] Importing Identity from Secret ---"
        if [ ! -f /etc/secret/identity.p12 ]; then
            echo "Error: Identity file not found. Setup Job might be running."
            exit 1
        fi
        ndnsec import -P password /etc/secret/identity.p12

        NETWORK_PREFIX="{{ config.network_prefix }}"
        SITE_NAME="{{ config.site_name }}"
        ROUTER_PREFIX="${NETWORK_PREFIX}/${SITE_NAME}/%C1.Router/${NODE_NAME}"

        ndnsec set-default "$ROUTER_PREFIX"
        ndnsec cert-dump -i "$ROUTER_PREFIX" > /etc/nlsr/router.cert

    else
        echo "--- [Lax] Generating Self-Signed Identity ---"
        NETWORK_PREFIX="{{ config.network_prefix }}"
        SITE_NAME="{{ config.site_name }}"
        ROUTER_PREFIX="${NETWORK_PREFIX}/${SITE_NAME}/%C1.Router/${NODE_NAME}"

        ndnsec key-gen "$ROUTER_PREFIX" | ndnsec cert-install -
        ndnsec set-default "$ROUTER_PREFIX"
        ndnsec cert-dump -i "$ROUTER_PREFIX" > /etc/nlsr/router.cert
    fi

    echo "--- Starting NFD ---"
    nfd-start > /var/log/nfd.log 2>&1 &
    NFD_PID=$!
    sleep 5

    echo "Waiting for NFD socket..."
    for i in {1..30}; do
        if [ -S /run/nfd/nfd.sock ]; then
            echo "NFD is ready."
            break
        fi
        sleep 2
    done

    echo "--- Creating Faces ---"
    IFS=',' read -ra ADDR <<< "$NEIGHBORS"
    for neighbor_pair in "${ADDR[@]}"; do
        neighbor_host="${neighbor_pair%%:*}"
        if [ ! -z "$neighbor_host" ]; then
            echo "Attempting to connect to ${neighbor_host}..."
            for i in {1..15}; do
                if nfdc face create tcp://${neighbor_host}; then
                    echo "Success: Connected to ${neighbor_host}"
                    break
                else
                    sleep 2
                fi
            done
        fi
    done

    sleep 2

    echo "--- Starting NLSR ---"
    nlsr -f /etc/nlsr/nlsr.conf &
    NLSR_PID=$!

    tail -f /var/log/nfd.log &
    wait $NFD_PID $NLSR_PID
